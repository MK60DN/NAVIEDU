<!-- ====== AIå¯¼å¸ˆèŠå¤©ç•Œé¢é¡µé¢ ====== -->
<!-- web/ai-tutor.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå­¦ä¹ å¯¼å¸ˆ - EduPath</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/ai-tutor.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app" class="ai-tutor-app">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="binance-navbar">
            <div class="nav-container">
                <div class="nav-left">
                    <div class="nav-brand">
                        <img src="assets/logo.svg" alt="EduPath" class="logo">
                        <span class="brand-text">EduPath</span>
                    </div>
                    <div class="nav-divider"></div>
                    <div class="nav-title">
                        <span class="ai-icon">ğŸ¤–</span>
                        <span class="title-text">AIå­¦ä¹ å¯¼å¸ˆ</span>
                    </div>
                </div>
                <div class="nav-right">
                    <div class="user-info" v-if="user">
                        <div class="token-balance">
                            <span class="token-label">$PYTHON</span>
                            <span class="token-amount">{{ user.pythonTokens || 0 }}</span>
                        </div>
                        <div class="user-avatar">
                            {{ user.username.charAt(0).toUpperCase() }}
                        </div>
                    </div>
                    <button @click="goHome" class="nav-btn">
                        <span>è¿”å›é¦–é¡µ</span>
                    </button>
                    <button @click="logout" class="nav-btn logout-btn">
                        <span>é€€å‡º</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="ai-tutor-main">
            <!-- å·¦ä¾§èŠå¤©é¢æ¿ -->
            <div class="chat-panel">
                <div class="chat-header">
                    <div class="header-content">
                        <h2>ğŸ¤– æ‚¨çš„ä¸“å±AIå­¦ä¹ å¯¼å¸ˆ</h2>
                        <p>æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥æ‰¾çŸ¥è¯†ç‚¹ã€è§„åˆ’å­¦ä¹ è·¯å¾„ã€è§£ç­”é—®é¢˜ã€æ”¶é›†çŸ¥è¯†è´¡çŒ®ï¼</p>
                        <div class="header-stats">
                            <div class="stat-item">
                                <span class="stat-value">{{ chatStats.totalChats }}</span>
                                <span class="stat-label">å¯¹è¯æ¬¡æ•°</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ chatStats.learnedTopics }}</span>
                                <span class="stat-label">å·²å­¦çŸ¥è¯†ç‚¹</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ chatStats.contributions }}</span>
                                <span class="stat-label">çŸ¥è¯†è´¡çŒ®</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages" ref="chatMessages">
                    <!-- æ¬¢è¿æ¶ˆæ¯ -->
                    <div class="message assistant welcome-message">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-bubble">
                            <div class="message-content">
                                <div class="welcome-text">
                                    <h3>æ¬¢è¿æ¥åˆ°AIå­¦ä¹ å¯¼å¸ˆï¼</h3>
                                    <p>æˆ‘æ˜¯æ‚¨çš„ä¸“å±å­¦ä¹ åŠ©æ‰‹"æ™ºå­¦"ï¼Œå¯ä»¥å¸®åŠ©æ‚¨ï¼š</p>
                                    <ul class="feature-list">
                                        <li>ğŸ” <strong>æ™ºèƒ½æœç´¢</strong> - æŸ¥æ‰¾å’Œè§£é‡Šå„ç§çŸ¥è¯†ç‚¹</li>
                                        <li>ğŸ—ºï¸ <strong>è·¯å¾„è§„åˆ’</strong> - åˆ¶å®šä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’</li>
                                        <li>ğŸ’¡ <strong>ç­”ç–‘è¾…å¯¼</strong> - è§£ç­”å­¦ä¹ ä¸­çš„ç–‘é—®</li>
                                        <li>ğŸ“š <strong>çŸ¥è¯†è´¡çŒ®</strong> - å¸®åŠ©å®Œå–„çŸ¥è¯†å›¾è°±</li>
                                    </ul>
                                    <p class="welcome-tip">ğŸ’¡ <strong>å°æç¤ºï¼š</strong>æ‚¨å¯ä»¥ç›´æ¥è¾“å…¥é—®é¢˜ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹çš„å¿«é€Ÿæ“ä½œæŒ‰é’®å¼€å§‹ï¼</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åŠ¨æ€æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    <div v-for="(message, index) in messages" :key="index"
                         :class="['message', message.type]">
                        <div v-if="message.type === 'user'" class="message-avatar user-avatar">
                            {{ user.username.charAt(0).toUpperCase() }}
                        </div>
                        <div v-else class="message-avatar">ğŸ¤–</div>
                        <div class="message-bubble">
                            <div class="message-content" v-html="formatMessage(message.content)"></div>
                            <div class="message-time">{{ formatTime(message.timestamp) }}</div>
                        </div>
                    </div>

                    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                    <div v-if="isLoading" class="message assistant">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-bubble loading-bubble">
                            <div class="typing-indicator">
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <span class="typing-text">æ™ºå­¦æ­£åœ¨æ€è€ƒä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                    <div class="quick-actions" v-if="!isInputFocused">
                        <button @click="sendQuickMessage('æˆ‘æƒ³å­¦ä¹ PythonåŸºç¡€')" class="quick-btn">
                            <span class="btn-icon">ğŸ</span>
                            <span>PythonåŸºç¡€</span>
                        </button>
                        <button @click="sendQuickMessage('å¸®æˆ‘è§„åˆ’å­¦ä¹ è·¯å¾„')" class="quick-btn">
                            <span class="btn-icon">ğŸ—ºï¸</span>
                            <span>å­¦ä¹ è·¯å¾„</span>
                        </button>
                        <button @click="sendQuickMessage('è§£é‡Šè£…é¥°å™¨çš„æ¦‚å¿µ')" class="quick-btn">
                            <span class="btn-icon">ğŸ’¡</span>
                            <span>æ¦‚å¿µè§£é‡Š</span>
                        </button>
                        <button @click="clearChat" class="quick-btn clear-btn">
                            <span class="btn-icon">ğŸ—‘ï¸</span>
                            <span>æ¸…ç©ºå¯¹è¯</span>
                        </button>
                    </div>

                    <!-- æ¶ˆæ¯è¾“å…¥æ¡† -->
                    <div class="input-container">
                        <div class="input-wrapper">
                            <input
                                type="text"
                                id="message-input"
                                ref="messageInput"
                                v-model="currentMessage"
                                @keypress="handleKeyPress"
                                @focus="isInputFocused = true"
                                @blur="isInputFocused = false"
                                :disabled="isLoading"
                                placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æƒ³å­¦ä¹ çš„å†…å®¹..."
                                maxlength="1000"
                            >
                            <button
                                @click="sendMessage"
                                :disabled="!currentMessage.trim() || isLoading"
                                class="send-btn"
                            >
                                <span v-if="!isLoading">å‘é€</span>
                                <span v-else class="loading-spinner"></span>
                            </button>
                        </div>
                        <div class="input-footer">
                            <div class="char-count">
                                {{ currentMessage.length }}/1000
                            </div>
                            <div class="input-tips">
                                ğŸ’¡ è¯•è¯•é—®æˆ‘"ä»€ä¹ˆæ˜¯Python"æˆ–"æˆ‘æƒ³å­¦ç¼–ç¨‹"
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ä¿¡æ¯é¢æ¿ -->
            <div class="info-panel">
                <!-- çŸ¥è¯†ç‚¹å±•ç¤ºåŒºåŸŸ -->
                <div v-if="knowledgePoints.length > 0" class="panel-section knowledge-section">
                    <div class="section-header">
                        <h3>ğŸ“š ç›¸å…³çŸ¥è¯†ç‚¹</h3>
                        <button @click="knowledgePoints = []" class="close-btn">Ã—</button>
                    </div>
                    <div class="knowledge-list">
                        <div
                            v-for="(point, index) in knowledgePoints"
                            :key="index"
                            @click="selectKnowledgePoint(index)"
                            class="knowledge-card"
                        >
                            <div class="card-header">
                                <h4>{{ point.name }}</h4>
                                <div class="difficulty-badge" :class="getDifficultyClass(point.difficulty)">
                                    {{ point.difficulty }}
                                </div>
                            </div>
                            <p class="card-description">{{ point.description }}</p>
                            <div class="card-meta">
                                <span class="meta-item">
                                    <span class="meta-icon">â±ï¸</span>
                                    {{ point.estimated_time }}
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">ğŸ·ï¸</span>
                                    {{ point.category }}
                                </span>
                            </div>
                            <div v-if="point.related_topics && point.related_topics.length > 0" class="related-topics">
                                <span class="related-label">ç›¸å…³ï¼š</span>
                                <span v-for="topic in point.related_topics.slice(0, 3)" :key="topic" class="topic-tag">
                                    {{ topic }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å­¦ä¹ è·¯å¾„å±•ç¤ºåŒºåŸŸ -->
                <div v-if="learningPaths.length > 0" class="panel-section path-section">
                    <div class="section-header">
                        <h3>ğŸ—ºï¸ æ¨èå­¦ä¹ è·¯å¾„</h3>
                        <button @click="learningPaths = []" class="close-btn">Ã—</button>
                    </div>
                    <div class="path-list">
                        <div
                            v-for="(path, pathIndex) in learningPaths"
                            :key="pathIndex"
                            class="path-card"
                        >
                            <div class="path-header">
                                <h4>è·¯å¾„ {{ pathIndex + 1 }}</h4>
                                <div class="path-stats">
                                    <span class="stat-badge">{{ path.nodes.length }}æ­¥</span>
                                    <span class="stat-badge">{{ path.estimated_total_time }}</span>
                                    <span class="stat-badge difficulty" :class="getDifficultyClass(path.difficulty_level)">
                                        {{ path.difficulty_level }}
                                    </span>
                                </div>
                            </div>
                            <div class="path-steps">
                                <div
                                    v-for="(step, stepIndex) in path.nodes"
                                    :key="stepIndex"
                                    @click="startLearningStep(pathIndex, stepIndex)"
                                    class="step-item"
                                >
                                    <div class="step-number">{{ step.step }}</div>
                                    <div class="step-content">
                                        <h5>{{ step.name }}</h5>
                                        <p>{{ step.description }}</p>
                                        <div class="step-meta">
                                            <span class="meta-tag">{{ step.difficulty }}</span>
                                            <span class="meta-tag">{{ step.estimated_time }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å­¦ä¹ è¿›åº¦é¢æ¿ -->
                <div class="panel-section progress-section">
                    <div class="section-header">
                        <h3>ğŸ“ˆ å­¦ä¹ è¿›åº¦</h3>
                    </div>
                    <div class="progress-content">
                        <div class="progress-item">
                            <div class="progress-label">å½“å‰ä¸»é¢˜</div>
                            <div class="progress-value">{{ currentTopic || 'æš‚æ— ' }}</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-label">ä»Šæ—¥å­¦ä¹ </div>
                            <div class="progress-value">{{ todayProgress.learned }} / {{ todayProgress.target }}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" :style="{ width: (todayProgress.learned / todayProgress.target * 100) + '%' }"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-label">çŸ¥è¯†è´¡çŒ®</div>
                            <div class="progress-value">{{ contributionCount }} ä¸ª</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-label">ä»£å¸ä½™é¢</div>
                            <div class="progress-value token-balance">
                                <span class="token-symbol">$PYTHON</span>
                                <span class="token-amount">{{ user.pythonTokens || 0 }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œé¢æ¿ -->
                <div class="panel-section actions-section">
                    <div class="section-header">
                        <h3>âš¡ å¿«é€Ÿæ“ä½œ</h3>
                    </div>
                    <div class="action-buttons">
                        <button @click="sendQuickMessage('æˆ‘æƒ³ç³»ç»Ÿå­¦ä¹ Python')" class="action-btn primary">
                            <span class="btn-icon">ğŸ¯</span>
                            <span>è§„åˆ’å­¦ä¹ è·¯å¾„</span>
                        </button>
                        <button @click="sendQuickMessage('æ¨èä¸€äº›ç»ƒä¹ é¢˜')" class="action-btn">
                            <span class="btn-icon">ğŸ“</span>
                            <span>è·å–ç»ƒä¹ é¢˜</span>
                        </button>
                        <button @click="sendQuickMessage('æ€»ç»“ä»Šå¤©çš„å­¦ä¹ å†…å®¹')" class="action-btn">
                            <span class="btn-icon">ğŸ“Š</span>
                            <span>å­¦ä¹ æ€»ç»“</span>
                        </button>
                        <button @click="openContributionModal" class="action-btn secondary">
                            <span class="btn-icon">ğŸ’¡</span>
                            <span>è´¡çŒ®çŸ¥è¯†</span>
                        </button>
                    </div>
                </div>

                <!-- AIå¯¼å¸ˆçŠ¶æ€ -->
                <div class="panel-section status-section">
                    <div class="section-header">
                        <h3>ğŸ¤– AIå¯¼å¸ˆçŠ¶æ€</h3>
                    </div>
                    <div class="status-content">
                        <div class="status-item">
                            <div class="status-indicator online"></div>
                            <div class="status-info">
                                <div class="status-label">æœåŠ¡çŠ¶æ€</div>
                                <div class="status-value">åœ¨çº¿æœåŠ¡</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-info">
                                <div class="status-label">å“åº”æ—¶é—´</div>
                                <div class="status-value">{{ responseTime }}ms</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-info">
                                <div class="status-label">ä»Šæ—¥æœåŠ¡</div>
                                <div class="status-value">{{ todayServices }} æ¬¡</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è´¡çŒ®çŸ¥è¯†æ¨¡æ€æ¡† -->
        <div v-if="showContributionModal" class="modal-overlay" @click="closeContributionModal">
            <div class="modal-container" @click.stop>
                <div class="modal-header">
                    <h3>ğŸ’¡ è´¡çŒ®çŸ¥è¯†ç‚¹</h3>
                    <button @click="closeContributionModal" class="modal-close">Ã—</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="submitContribution">
                        <div class="form-group">
                            <label>æ¦‚å¿µåç§° *</label>
                            <input
                                type="text"
                                v-model="contributionForm.name"
                                placeholder="å¦‚ï¼šPythonè£…é¥°å™¨ã€React Hooksç­‰"
                                required
                                maxlength="100"
                            >
                        </div>
                        <div class="form-group">
                            <label>è¯¦ç»†æè¿° *</label>
                            <textarea
                                v-model="contributionForm.description"
                                placeholder="è¯·è¯¦ç»†æè¿°è¿™ä¸ªæ¦‚å¿µçš„å®šä¹‰ã€ç”¨é€”ã€ç‰¹ç‚¹ç­‰..."
                                required
                                maxlength="1000"
                                rows="4"
                            ></textarea>
                            <div class="char-count">{{ contributionForm.description.length }}/1000</div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>éš¾åº¦çº§åˆ«</label>
                                <select v-model="contributionForm.difficulty">
                                    <option value="å…¥é—¨">å…¥é—¨</option>
                                    <option value="åˆçº§">åˆçº§</option>
                                    <option value="ä¸­çº§">ä¸­çº§</option>
                                    <option value="é«˜çº§">é«˜çº§</option>
                                    <option value="ä¸“å®¶">ä¸“å®¶</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>å­¦ä¹ æ—¶é•¿</label>
                                <select v-model="contributionForm.estimated_time">
                                    <option value="15åˆ†é’Ÿ">15åˆ†é’Ÿ</option>
                                    <option value="30åˆ†é’Ÿ">30åˆ†é’Ÿ</option>
                                    <option value="1å°æ—¶">1å°æ—¶</option>
                                    <option value="2å°æ—¶">2å°æ—¶</option>
                                    <option value="åŠå¤©">åŠå¤©</option>
                                    <option value="1å¤©">1å¤©</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>åˆ†ç±»æ ‡ç­¾</label>
                            <input
                                type="text"
                                v-model="contributionForm.category"
                                placeholder="å¦‚ï¼šç¼–ç¨‹è¯­è¨€ã€ç®—æ³•ã€æ¡†æ¶ã€å·¥å…·ç­‰"
                                maxlength="50"
                            >
                        </div>
                        <div class="form-group">
                            <label>å‰ç½®çŸ¥è¯†</label>
                            <input
                                type="text"
                                v-model="contributionForm.prerequisites"
                                placeholder="å­¦ä¹ è¿™ä¸ªæ¦‚å¿µéœ€è¦å…ˆæŒæ¡ä»€ä¹ˆï¼Ÿï¼ˆå¯é€‰ï¼‰"
                                maxlength="200"
                            >
                        </div>
                        <div class="modal-footer">
                            <button type="button" @click="closeContributionModal" class="btn-cancel">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" :disabled="isSubmittingContribution" class="btn-submit">
                                <span v-if="!isSubmittingContribution">æäº¤è´¡çŒ® (+10 $PYTHON)</span>
                                <span v-else>æäº¤ä¸­...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Toasté€šçŸ¥ -->
        <div v-if="toast.show" :class="['toast', toast.type]">
            <div class="toast-content">
                <span class="toast-icon">{{ getToastIcon(toast.type) }}</span>
                <span class="toast-message">{{ toast.message }}</span>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬å¼•å…¥ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/aiTutor.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // ç”¨æˆ·ä¿¡æ¯
                    user: null,

                    // èŠå¤©ç›¸å…³
                    messages: [],
                    currentMessage: '',
                    isLoading: false,
                    isInputFocused: false,

                    // çŸ¥è¯†ç‚¹å’Œè·¯å¾„
                    knowledgePoints: [],
                    learningPaths: [],

                    // æ¨¡æ€æ¡†
                    showContributionModal: false,
                    isSubmittingContribution: false,

                    // è´¡çŒ®è¡¨å•
                    contributionForm: {
                        name: '',
                        description: '',
                        difficulty: 'ä¸­çº§',
                        category: 'ç¼–ç¨‹',
                        estimated_time: '30åˆ†é’Ÿ',
                        prerequisites: ''
                    },

                    // ç»Ÿè®¡æ•°æ®
                    chatStats: {
                        totalChats: 0,
                        learnedTopics: 0,
                        contributions: 0
                    },

                    // è¿›åº¦æ•°æ®
                    currentTopic: '',
                    todayProgress: {
                        learned: 0,
                        target: 5
                    },
                    contributionCount: 0,

                    // çŠ¶æ€ç›‘æ§
                    responseTime: 0,
                    todayServices: 0,

                    // Toasté€šçŸ¥
                    toast: {
                        show: false,
                        type: 'info',
                        message: ''
                    }
                }
            },

            mounted() {
                this.initializeApp();
                this.loadUserData();
                this.loadChatHistory();
                this.focusInput();
            },

            methods: {
                // åˆå§‹åŒ–åº”ç”¨
                async initializeApp() {
                    // æ£€æŸ¥ç™»å½•çŠ¶æ€
                    const token = localStorage.getItem('token');
                    if (!token) {
                        this.showToast('è¯·å…ˆç™»å½•ï¼', 'error');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                        return;
                    }

                    try {
                        // è·å–ç”¨æˆ·ä¿¡æ¯
                        const userResponse = await apiRequest('/auth/me');
                        if (userResponse.success) {
                            this.user = userResponse.data;
                            this.updateChatStats();
                        }
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                        this.showToast('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
                    }
                },

                // åŠ è½½ç”¨æˆ·æ•°æ®
                loadUserData() {
                    // ä»localStorageåŠ è½½èŠå¤©ç»Ÿè®¡
                    const savedStats = localStorage.getItem('chatStats');
                    if (savedStats) {
                        this.chatStats = { ...this.chatStats, ...JSON.parse(savedStats) };
                    }

                    // åŠ è½½ä»Šæ—¥è¿›åº¦
                    const today = new Date().toDateString();
                    const todayProgress = localStorage.getItem(`progress_${today}`);
                    if (todayProgress) {
                        this.todayProgress = { ...this.todayProgress, ...JSON.parse(todayProgress) };
                    }
                },

                // åŠ è½½èŠå¤©å†å²
                loadChatHistory() {
                    const saved = localStorage.getItem('aiTutorHistory');
                    if (saved) {
                        try {
                            const history = JSON.parse(saved);
                            this.messages = history.slice(-20); // åªåŠ è½½æœ€è¿‘20æ¡
                        } catch (error) {
                            console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);
                        }
                    }
                },

                // å‘é€æ¶ˆæ¯
                async sendMessage() {
                    const message = this.currentMessage.trim();
                    if (!message || this.isLoading) return;

                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                    this.addMessage('user', message);
                    this.currentMessage = '';
                    this.isLoading = true;

                    const startTime = Date.now();

                    try {
                        const response = await apiRequest('/ai-tutor/chat', {
                            method: 'POST',
                            body: JSON.stringify({
                                message: message,
                                conversation_history: this.getConversationHistory()
                            })
                        });

                        this.responseTime = Date.now() - startTime;
                        this.todayServices++;

                        if (response.success) {
                            const aiResponse = response.data;

                            // æ·»åŠ AIå›å¤
                            this.addMessage('assistant', aiResponse.content, aiResponse);

                            // å¤„ç†ç‰¹æ®Šå“åº”ç±»å‹
                            this.handleSpecialResponse(aiResponse);

                            // æ›´æ–°ç»Ÿè®¡
                            this.chatStats.totalChats++;
                            this.saveChatStats();

                        } else {
                            throw new Error(response.message || 'è¯·æ±‚å¤±è´¥');
                        }

                    } catch (error) {
                        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                        this.addMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤æ‚¨çš„æ¶ˆæ¯ï¼Œè¯·ç¨åé‡è¯•ã€‚');
                        this.showToast('å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    } finally {
                        this.isLoading = false;
                        this.scrollToBottom();
                    }
                },

                // å¿«é€Ÿå‘é€æ¶ˆæ¯
                sendQuickMessage(message) {
                    this.currentMessage = message;
                    this.sendMessage();
                },

                // æ·»åŠ æ¶ˆæ¯åˆ°å†å²
                addMessage(type, content, data = null) {
                    const message = {
                        type,
                        content,
                        timestamp: Date.now(),
                        data
                    };

                    this.messages.push(message);

                    // é™åˆ¶æ¶ˆæ¯æ•°é‡
                    if (this.messages.length > 50) {
                        this.messages = this.messages.slice(-40);
                    }

                    // ä¿å­˜åˆ°localStorage
                    this.saveChatHistory();

                    // è‡ªåŠ¨æ»šåŠ¨
                    this.$nextTick(() => {
                        this.scrollToBottom();
                    });
                },

                // å¤„ç†ç‰¹æ®Šå“åº”
                handleSpecialResponse(response) {
                    switch (response.type) {
                        case 'knowledge_search':
                            if (response.data && response.data.knowledge_points) {
                                this.knowledgePoints = response.data.knowledge_points;
                            }
                            break;
                        case 'learning_path':
                            if (response.data && response.data.paths) {
                                this.learningPaths = response.data.paths;
                            }
                            break;
                        case 'contribution_request':
                            // è‡ªåŠ¨æ‰“å¼€è´¡çŒ®æ¨¡æ€æ¡†
                            if (response.data && response.data.new_concepts) {
                                this.contributionForm.name = response.data.new_concepts[0] || '';
                                this.openContributionModal();
                            }
                            break;
                        case 'learning_assistance':
                            if (response.data && response.data.current_topic) {
                                this.currentTopic = response.data.current_topic;
                            }
                            break;
                    }
                },

                // é€‰æ‹©çŸ¥è¯†ç‚¹
                selectKnowledgePoint(index) {
                    const point = this.knowledgePoints[index];
                    this.sendQuickMessage(`æˆ‘æƒ³å­¦ä¹ ï¼š${point.name}`);
                },

                // å¼€å§‹å­¦ä¹ æ­¥éª¤
                startLearningStep(pathIndex, stepIndex) {
                    const step = this.learningPaths[pathIndex].nodes[stepIndex];
                    this.sendQuickMessage(`å¼€å§‹å­¦ä¹ ï¼š${step.name}`);

                    // æ›´æ–°å½“å‰ä¸»é¢˜
                    this.currentTopic = step.name;
                    this.todayProgress.learned++;
                    this.saveTodayProgress();
                },

                // æ‰“å¼€è´¡çŒ®æ¨¡æ€æ¡†
                openContributionModal() {
                    this.showContributionModal = true;
                },

                // å…³é—­è´¡çŒ®æ¨¡æ€æ¡†
                closeContributionModal() {
                    this.showContributionModal = false;
                    // é‡ç½®è¡¨å•
                    this.contributionForm = {
                        name: '',
                        description: '',
                        difficulty: 'ä¸­çº§',
                        category: 'ç¼–ç¨‹',
                        estimated_time: '30åˆ†é’Ÿ',
                        prerequisites: ''
                    };
                },

                // æäº¤è´¡çŒ®
                async submitContribution() {
                    if (this.isSubmittingContribution) return;

                    // éªŒè¯è¡¨å•
                    if (!this.contributionForm.name.trim() || !this.contributionForm.description.trim()) {
                        this.showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                        return;
                    }

                    this.isSubmittingContribution = true;

                    try {
                        const response = await apiRequest('/ai-tutor/contribute', {
                            method: 'POST',
                            body: JSON.stringify(this.contributionForm)
                        });

                        if (response.success) {
                            this.showToast(response.data.message || 'è´¡çŒ®æˆåŠŸï¼å·²è·å¾—10ä¸ª$PYTHONä»£å¸å¥–åŠ±ï¼', 'success');
                            this.contributionCount++;
                            this.chatStats.contributions++;
                            this.user.pythonTokens = (this.user.pythonTokens || 0) + 10;
                            this.closeContributionModal();
                            this.saveChatStats();
                        } else {
                            throw new Error(response.message || 'æäº¤å¤±è´¥');
                        }

                    } catch (error) {
                        console.error('æäº¤è´¡çŒ®å¤±è´¥:', error);
                        this.showToast('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    } finally {
                        this.isSubmittingContribution = false;
                    }
                },

                // æ¸…ç©ºèŠå¤©
                clearChat() {
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
                        this.messages = [];
                        this.knowledgePoints = [];
                        this.learningPaths = [];
                        localStorage.removeItem('aiTutorHistory');
                        this.showToast('å¯¹è¯è®°å½•å·²æ¸…ç©º', 'info');
                    }
                },

                // é”®ç›˜äº‹ä»¶
                handleKeyPress(event) {
                    if (event.key === 'Enter') {
                        this.sendMessage();
                    }
                },

                // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
                formatMessage(content) {
                    if (!content) return '';

                    // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
                    content = content.replace(/\n/g, '<br>');

                    // å¤„ç†markdowné£æ ¼çš„ç²—ä½“
                    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                    // å¤„ç†ä»£ç å—
                    content = content.replace(/`([^`]+)`/g, '<code>$1</code>');

                    return content;
                },

                // æ ¼å¼åŒ–æ—¶é—´
                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    const now = new Date();

                    if (date.toDateString() === now.toDateString()) {
                        return date.toLocaleTimeString('zh-CN', {
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } else {
                        return date.toLocaleDateString('zh-CN', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                },

                // è·å–éš¾åº¦æ ·å¼ç±»
                getDifficultyClass(difficulty) {
                    const classMap = {
                        'å…¥é—¨': 'difficulty-beginner',
                        'åˆçº§': 'difficulty-basic',
                        'ä¸­çº§': 'difficulty-intermediate',
                        'é«˜çº§': 'difficulty-advanced',
                        'ä¸“å®¶': 'difficulty-expert'
                    };
                    return classMap[difficulty] || 'difficulty-intermediate';
                },

                // è·å–Toastå›¾æ ‡
                getToastIcon(type) {
                    const icons = {
                        success: 'âœ…',
                        error: 'âŒ',
                        warning: 'âš ï¸',
                        info: 'â„¹ï¸'
                    };
                    return icons[type] || 'â„¹ï¸';
                },

                // æ˜¾ç¤ºToast
                showToast(message, type = 'info') {
                    this.toast = {
                        show: true,
                        type,
                        message
                    };

                    setTimeout(() => {
                        this.toast.show = false;
                    }, 4000);
                },

                // æ»šåŠ¨åˆ°åº•éƒ¨
                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = this.$refs.chatMessages;
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },

                // èšç„¦è¾“å…¥æ¡†
                focusInput() {
                    this.$nextTick(() => {
                        if (this.$refs.messageInput) {
                            this.$refs.messageInput.focus();
                        }
                    });
                },

                // è·å–å¯¹è¯å†å²
                getConversationHistory() {
                    return this.messages.slice(-10).map(msg => ({
                        role: msg.type === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    }));
                },

                // ä¿å­˜èŠå¤©å†å²
                saveChatHistory() {
                    try {
                        localStorage.setItem('aiTutorHistory', JSON.stringify(this.messages));
                    } catch (error) {
                        console.error('ä¿å­˜èŠå¤©å†å²å¤±è´¥:', error);
                    }
                },

                // ä¿å­˜ç»Ÿè®¡æ•°æ®
                saveChatStats() {
                    try {
                        localStorage.setItem('chatStats', JSON.stringify(this.chatStats));
                    } catch (error) {
                        console.error('ä¿å­˜ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                    }
                },

                // ä¿å­˜ä»Šæ—¥è¿›åº¦
                saveTodayProgress() {
                    try {
                        const today = new Date().toDateString();
                        localStorage.setItem(`progress_${today}`, JSON.stringify(this.todayProgress));
                    } catch (error) {
                        console.error('ä¿å­˜è¿›åº¦å¤±è´¥:', error);
                    }
                },

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateChatStats() {
                    // è¿™é‡Œå¯ä»¥ä»æœåŠ¡å™¨è·å–æ›´å‡†ç¡®çš„ç»Ÿè®¡æ•°æ®
                    this.chatStats.learnedTopics = Math.floor(this.chatStats.totalChats / 3);
                },

                // å¯¼èˆªæ“ä½œ
                goHome() {
                    window.location.href = 'index.html';
                },

                logout() {
                    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>