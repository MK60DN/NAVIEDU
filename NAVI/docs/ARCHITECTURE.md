# Navi 架构设计文档

## 项目概述

Navi 是一个基于 DeepSeek API 的智能学习助手，采用多智能体协作架构，通过学习辅导、批判思考和知识图谱构建，为用户提供个性化的学习体验。

## 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (React)   │    │  后端 (FastAPI)  │    │ DeepSeek API    │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 学习模式    │ │◄──►│ │ 学习智能体  │ │◄──►│ │ deepseek-   │ │
│ │             │ │    │ │             │ │    │ │ chat        │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │                 │
│ │ 对话模式    │ │◄──►│ │ 质疑智能体  │ │    │                 │
│ │             │ │    │ │             │ │    │                 │
│ └─────────────┘ │    │ └─────────────┘ │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │                 │
│ │ 知识图谱    │ │◄──►│ │ 平衡智能体  │ │    │                 │
│ │             │ │    │ │             │ │    │                 │
│ └─────────────┘ │    │ └─────────────┘ │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐    ┌─────────────────┐
│ 本地存储        │    │ 文件存储        │
│ (LocalStorage)  │    │ (JSON/SQLite)   │
└─────────────────┘    └─────────────────┘
```

## 前端架构

### 技术栈
- **React 18**: 主要UI框架
- **Hooks**: 状态管理和副作用处理
- **Tailwind CSS**: 样式框架（内联样式）
- **Lucide React**: 图标库
- **Axios**: HTTP 客户端

### 组件架构

```
src/
├── App.js                 # 根组件，路由管理
├── components/            # UI组件
│   ├── Header.js         # 顶部导航栏
│   ├── LearningMode.js   # 学习模式组件
│   ├── ChatMode.js       # 对话模式组件
│   ├── KnowledgeGraph.js # 知识图谱组件
│   ├── InputBar.js       # 输入组件
│   └── MessageList.js    # 消息列表组件
├── hooks/                # 自定义Hooks
│   ├── useLocalStorage.js   # 本地存储Hook
│   ├── useNaviAPI.js        # API调用Hook
│   └── useKnowledgeGraph.js # 知识图谱Hook
├── services/             # 服务层
│   ├── naviAPI.js        # API服务封装
│   ├── localDB.js        # 本地数据库
│   └── voiceService.js   # 语音服务
└── utils/                # 工具函数
    ├── constants.js      # 常量定义
    ├── helpers.js        # 辅助函数
    └── storage.js        # 存储工具
```

### 状态管理
- 使用 React Hooks (useState, useEffect, useCallback)
- 自定义 Hook 封装复杂逻辑
- 本地存储作为持久化方案

## 后端架构

### 技术栈
- **FastAPI**: Web 框架
- **aiohttp**: 异步HTTP客户端
- **pydantic**: 数据验证
- **uvicorn**: ASGI 服务器

### 多智能体架构

```python
DeepSeekBaseAgent (基类)
├── DeepSeekLearningAgent (学习智能体)
├── DeepSeekQuestioningAgent (质疑智能体)
└── DeepSeekBalancingAgent (平衡智能体)
```

#### 智能体职责分工

1. **学习智能体 (Learning Agent)**
   - 提供系统化知识解释
   - 设计学习路径
   - 生成实例和练习
   - 权重: 1.618 (黄金比例)

2. **质疑智能体 (Questioning Agent)**
   - 提出批判性问题
   - 挑战假设和观点
   - 培养批判思维
   - 权重: 1.414 (√2)

3. **平衡智能体 (Balancing Agent)**
   - 协调不同观点
   - 综合分析建议
   - 决策知识图谱更新
   - 权重: 1.0 (中性)

### 服务层架构

```python
services/
├── deepseek_service.py    # DeepSeek API封装
├── knowledge_service.py   # 知识图谱管理
└── storage_service.py     # 数据存储服务
```

## 数据流架构

### 学习模式数据流

```
用户输入 → 学习智能体 → DeepSeek API → 学习回应
                                      ↓
质疑智能体 ← 学习回应  ← 平衡智能体 ← 知识图谱更新决策
    ↓
质疑回应 → 知识图谱服务 → 本地存储/文件存储
```

### 知识图谱更新流程

```
1. 用户提问
2. 学习智能体生成教学内容
3. 质疑智能体生成批判性思考
4. 平衡智能体分析并决定更新策略
5. 知识图谱服务执行更新
6. 更新结果持久化
```

## 存储架构

### 前端存储 (LocalStorage)
- 用户会话数据
- 知识图谱缓存
- 用户设置
- 离线数据

### 后端存储 (文件系统)
- 用户会话备份
- 知识图谱完整版本
- 系统日志
- 临时文件

### 数据结构

#### 知识图谱节点
```json
{
  "id": "unique_id",
  "title": "节点标题",
  "content": "详细内容",
  "type": "learning|questioning|manual|system",
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T00:00:00Z",
  "metadata": {
    "keywords": ["关键词1", "关键词2"],
    "user_question": "原始问题",
    "learning_response": "学习助手回应",
    "questioning_response": "质疑助手回应"
  },
  "children": []
}
```

#### 消息结构
```json
{
  "id": "message_id",
  "content": "消息内容",
  "sender": "user|assistant",
  "type": "learning|questioning|chat",
  "timestamp": "2024-01-01T00:00:00Z",
  "metadata": {
    "tokens_used": 150,
    "response_time": 2.3,
    "quality_score": 0.85
  }
}
```

## 安全架构

### API 安全
- API Key 认证
- 请求速率限制
- 输入数据验证
- 错误信息过滤

### 数据安全
- 本地存储加密（计划）
- 敏感数据脱敏
- 定期数据备份
- 用户数据隔离

## 性能优化

### 前端优化
- 组件懒加载
- 虚拟滚动（长对话）
- 本地缓存策略
- 防抖输入处理

### 后端优化
- 异步请求处理
- 连接池管理
- 响应缓存
- 批量API调用

### API优化
- 智能体响应缓存
- Token使用优化
- 并发请求控制
- 失败重试机制

## 扩展性设计

### 智能体扩展
- 插件化智能体架构
- 动态权重调整
- 新智能体热加载

### 功能扩展
- 多语言支持
- 主题系统
- 插件系统
- 第三方集成

### 部署扩展
- 容器化部署
- 负载均衡
- 微服务拆分
- 云原生架构

## 监控和日志

### 日志架构
```
应用日志 → 结构化输出 → 日志收集 → 分析展示
├── 用户行为日志
├── API调用日志
├── 错误日志
└── 性能日志
```

### 监控指标
- API响应时间
- 智能体调用频率
- 用户活跃度
- 系统资源使用

## 未来规划

### 短期目标
- 完善知识图谱算法
- 增加语音交互
- 优化移动端体验
- 添加数据导出功能

### 长期目标
- 多用户协作
- 智能推荐系统
- 高级数据分析
- 企业级部署方案